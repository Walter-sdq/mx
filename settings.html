<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Top-Margin  Trading</title>
    <meta name="description" content="Manage your Top-Margin  account settings">
    
    <link rel="icon" type="image/svg+xml" href="img/logo.svg">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Simplified header for settings page -->
        <header class="topbar">
            <div class="topbar-left">
                <a href="dashboard.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="page-title">Settings</h1>
            </div>
            
            <div class="topbar-right">
                <button class="theme-toggle" id="theme-toggle">
                    <i class="fas fa-sun"></i>
                </button>
            </div>
        </header>

        <main class="content">
            <div class="settings-container">
                <!-- Account Section -->
                <div class="settings-section">
                    <h3>Account</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Profile Information</div>
                            <div class="setting-subtitle">Update your personal details</div>
                        </div>
                        <button class="setting-action" onclick="openModal('profile-modal')">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Change Password</div>
                            <div class="setting-subtitle">Update your account password</div>
                        </div>
                        <button class="setting-action" onclick="openModal('password-modal')">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Preferences Section -->
                <div class="settings-section">
                    <h3>Preferences</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Dark Mode</div>
                            <div class="setting-subtitle">Switch between light and dark theme</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="dark-mode-setting">
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Push Notifications</div>
                            <div class="setting-subtitle">Receive alerts for trades and updates</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="notifications-setting" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Email Notifications</div>
                            <div class="setting-subtitle">Receive important updates via email</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="email-setting" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">SMS Alerts</div>
                            <div class="setting-subtitle">Get trade confirmations via SMS</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="sms-setting">
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                </div>

                <!-- Security Section -->
                <div class="settings-section">
                    <h3>Security</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Two-Factor Authentication</div>
                            <div class="setting-subtitle">Add extra security to your account</div>
                        </div>
                        <button class="setting-action" onclick="openModal('2fa-modal')">
                            <span class="status-text">Setup</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Biometric Login</div>
                            <div class="setting-subtitle">Use fingerprint or face ID</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="biometric-setting">
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Session Timeout</div>
                            <div class="setting-subtitle">Auto-logout after inactivity</div>
                        </div>
                        <select class="setting-select" id="session-timeout">
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="60" selected>1 hour</option>
                            <option value="240">4 hours</option>
                        </select>
                    </div>
                </div>

                <!-- Support Section -->
                <div class="settings-section">
                    <h3>Support</h3>
                    
                    <div class="setting-item clickable">
                        <div class="setting-info">
                            <div class="setting-title">Help Center</div>
                            <div class="setting-subtitle">FAQs and tutorials</div>
                        </div>
                        <i class="fas fa-external-link-alt"></i>
                    </div>
                    
                    <div class="setting-item clickable">
                        <div class="setting-info">
                            <div class="setting-title">Contact Support</div>
                            <div class="setting-subtitle">Get help from our team</div>
                        </div>
                        <i class="fas fa-external-link-alt"></i>
                    </div>
                    
                    <div class="setting-item clickable">
                        <div class="setting-info">
                            <div class="setting-title">Report a Bug</div>
                            <div class="setting-subtitle">Help us improve the platform</div>
                        </div>
                        <i class="fas fa-external-link-alt"></i>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="settings-section danger">
                    <h3>Account Actions</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Export Data</div>
                            <div class="setting-subtitle">Download your account data</div>
                        </div>
                        <button class="setting-action" onclick="exportAccountData()">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Logout</div>
                            <div class="setting-subtitle">Sign out of your account</div>
                        </div>
                        <button class="setting-action danger" onclick="confirmLogout()">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Profile Information</h3>
                <button class="modal-close" onclick="closeModal('profile-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form class="profile-form" id="profile-form">
                    <div class="form-group">
                        <label for="profile-name">Full Name</label>
                        <input type="text" id="profile-name" required>
                        <div class="error-message" id="profile-name-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="profile-email">Email Address</label>
                        <input type="email" id="profile-email" required>
                        <div class="error-message" id="profile-email-error"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Profile</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal" id="password-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Password</h3>
                <button class="modal-close" onclick="closeModal('password-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form class="password-form" id="password-form">
                    <div class="form-group">
                        <label for="current-password">Current Password</label>
                        <input type="password" id="current-password" required>
                        <div class="error-message" id="current-password-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" required>
                        <div class="password-strength" id="password-strength"></div>
                        <div class="error-message" id="new-password-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirm New Password</label>
                        <input type="password" id="confirm-password" required>
                        <div class="error-message" id="confirm-password-error"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 2FA Modal -->
    <div class="modal" id="2fa-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Two-Factor Authentication</h3>
                <button class="modal-close" onclick="closeModal('2fa-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="2fa-setup">
                    <div class="setup-step">
                        <h4>Setup Instructions</h4>
                        <p>Two-factor authentication will be available upon full backend integration. This feature adds an extra layer of security to your account.</p>
                        <div class="setup-placeholder">
                            <i class="fas fa-mobile-alt"></i>
                            <span>Coming Soon</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modal-overlay"></div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <button class="nav-item" data-page="home">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </button>
      <button class="nav-item" data-page="trading">
        <i class="fas fa-chart-line"></i>
        <span>Trading</span>
      </button>
      <button class="nav-item" data-page="transactions">
        <i class="fas fa-exchange-alt"></i>
        <span>Transactions</span>
      </button>
      <button class="nav-item" data-page="notifications">
        <i class="fas fa-bell"></i>
        <span>Notifications</span>
      </button>
      <button class="nav-item" data-page="support">
        <i class="fas fa-headset"></i>
        <span>Support</span>
      </button>
    </nav>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import { authManager } from './js/auth.js';
        import { apiClient } from './js/api.js';
        import { showToast, showLoading, isValidEmail, checkPasswordStrength } from './js/utils.js';
        
        document.addEventListener('DOMContentLoaded', () => {
            initSettingsPage();
            initializePageNavigation();
        });

        async function initSettingsPage() {
            // Check authentication
            if (!authManager.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            const profile = authManager.getProfile();
            
            if (profile) {
                loadUserSettings(profile);
            }

            setupSettingsForm();
        }

        function loadUserSettings(profile) {
            // Load current settings
            const settings = profile.settings || {};
            
            document.getElementById('dark-mode-setting').checked = settings.dark_mode !== false;
            document.getElementById('notifications-setting').checked = settings.notifications !== false;
            document.getElementById('email-setting').checked = settings.email_notifications !== false;
            document.getElementById('sms-setting').checked = settings.sms_notifications === true;
            document.getElementById('biometric-setting').checked = settings.biometric === true;
            
            // Load profile info
            const profileName = document.getElementById('profile-name');
            const profileEmail = document.getElementById('profile-email');
            
            if (profileName) profileName.value = profile.full_name;
            if (profileEmail) profileEmail.value = profile.email;
        }

        function setupSettingsForm() {
            // Toggle switches
            const toggles = document.querySelectorAll('.toggle-switch input');
            toggles.forEach(toggle => {
                toggle.addEventListener('change', () => {
                    saveSettings();
                });
            });

            // Session timeout
            const sessionTimeout = document.getElementById('session-timeout');
            if (sessionTimeout) {
                sessionTimeout.addEventListener('change', () => {
                    saveSettings();
                });
            }

            // Profile form
            const profileForm = document.getElementById('profile-form');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateProfile();
                });
            }

            // Password form
            const passwordForm = document.getElementById('password-form');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }

            // Password strength indicator
            const newPasswordInput = document.getElementById('new-password');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
        }

        async function saveSettings() {
            if (!authManager.isAuthenticated()) return;

            const settings = {
                dark_mode: document.getElementById('dark-mode-setting').checked,
                notifications: document.getElementById('notifications-setting').checked,
                email_notifications: document.getElementById('email-setting').checked,
                sms_notifications: document.getElementById('sms-setting').checked,
                biometric: document.getElementById('biometric-setting').checked,
                session_timeout: parseInt(document.getElementById('session-timeout').value)
            };

            try {
                await apiClient.updateUser(authManager.getUser().id, { settings });
                
                // Apply dark mode immediately
                if (settings.dark_mode !== (document.documentElement.getAttribute('data-theme') === 'dark')) {
                    toggleTheme();
                }
            
                showToast('Settings saved successfully', 'success');
            } catch (error) {
                console.error('Settings save error:', error);
                showToast('Failed to save settings', 'error');
            }
        }

        async function updateProfile() {
            if (!authManager.isAuthenticated()) return;

            const fullName = document.getElementById('profile-name').value.trim();
            const email = document.getElementById('profile-email').value.trim().toLowerCase();

            // Validate form
            if (!validateProfileForm()) {
                return;
            }

            // Sanitize inputs
            const sanitizedName = sanitizeInput(fullName);
            const sanitizedEmail = sanitizeInput(email);

            try {
                await apiClient.updateUser(authManager.getUser().id, {
                    full_name: sanitizedName,
                    email: sanitizedEmail
                });

                showToast('Profile updated successfully', 'success');
                closeModal('profile-modal');

            } catch (error) {
                console.error('Profile update error:', error);
                showToast('Failed to update profile', 'error');
            }
        }

        async function changePassword() {
            if (!authManager.isAuthenticated()) return;

            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            // Validate form
            if (!validatePasswordForm()) {
                return;
            }

            try {
                // Use Supabase auth to update password
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) {
                    throw new Error(error.message);
                }

                showToast('Password changed successfully', 'success');
                closeModal('password-modal');

                // Clear form
                document.getElementById('password-form').reset();

            } catch (error) {
                console.error('Password change error:', error);
                showToast('Failed to change password', 'error');
            }
        }

        function validateProfileForm() {
            const nameInput = document.getElementById('profile-name');
            const emailInput = document.getElementById('profile-email');
            const name = nameInput.value.trim();
            const email = emailInput.value.trim().toLowerCase();

            let isValid = true;

            // Name validation
            if (!name) {
                document.getElementById('profile-name-error').textContent = 'Full name is required';
                nameInput.classList.add('error');
                isValid = false;
            } else if (name.length < 2) {
                document.getElementById('profile-name-error').textContent = 'Name must be at least 2 characters';
                nameInput.classList.add('error');
                isValid = false;
            } else {
                document.getElementById('profile-name-error').textContent = '';
                nameInput.classList.remove('error');
            }

            // Email validation
            if (!email) {
                document.getElementById('profile-email-error').textContent = 'Email is required';
                emailInput.classList.add('error');
                isValid = false;
            } else if (!isValidEmail(email)) {
                document.getElementById('profile-email-error').textContent = 'Please enter a valid email address';
                emailInput.classList.add('error');
                isValid = false;
            } else {
                document.getElementById('profile-email-error').textContent = '';
                emailInput.classList.remove('error');
            }

            return isValid;
        }

        function validatePasswordForm() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            let isValid = true;

            // Current password validation
            if (!currentPassword) {
                document.getElementById('current-password-error').textContent = 'Current password is required';
                document.getElementById('current-password').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('current-password-error').textContent = '';
                document.getElementById('current-password').classList.remove('error');
            }

            // New password validation
            if (!newPassword) {
                document.getElementById('new-password-error').textContent = 'New password is required';
                document.getElementById('new-password').classList.add('error');
                isValid = false;
            } else {
                const strength = checkPasswordStrength(newPassword);
                if (strength.score < 3) {
                    document.getElementById('new-password-error').textContent = 'Password is too weak. Please use a stronger password.';
                    document.getElementById('new-password').classList.add('error');
                    isValid = false;
                } else {
                    document.getElementById('new-password-error').textContent = '';
                    document.getElementById('new-password').classList.remove('error');
                }
            }

            // Confirm password validation
            if (!confirmPassword) {
                document.getElementById('confirm-password-error').textContent = 'Please confirm your new password';
                document.getElementById('confirm-password').classList.add('error');
                isValid = false;
            } else if (newPassword !== confirmPassword) {
                document.getElementById('confirm-password-error').textContent = 'Passwords do not match';
                document.getElementById('confirm-password').classList.add('error');
                isValid = false;
            } else {
                document.getElementById('confirm-password-error').textContent = '';
                document.getElementById('confirm-password').classList.remove('error');
            }

            return isValid;
        }

        function updatePasswordStrength() {
            const password = document.getElementById('new-password').value;
            const strengthElement = document.getElementById('password-strength');
            const strength = checkPasswordStrength(password);

            strengthElement.innerHTML = `
                <div class="strength-bar ${strength.class}">
                    <div class="strength-fill"></div>
                </div>
                <span class="strength-text">${strength.text}</span>
                ${strength.feedback ? `<div class="strength-feedback">${strength.feedback}</div>` : ''}
            `;
        }

        async function exportAccountData() {
            if (!authManager.isAuthenticated()) return;

            try {
                const profile = authManager.getProfile();
                const { data: transactions } = await apiClient.getTransactions(authManager.getUser().id);
                const { data: trades } = await apiClient.getTrades(authManager.getUser().id);
                const { data: notifications } = await apiClient.getNotifications(authManager.getUser().id);

                const exportData = {
                    user: {
                        fullName: profile.full_name,
                        email: profile.email,
                        role: profile.role,
                        createdAt: profile.created_at,
                        balances: profile.balances
                    },
                    transactions: transactions || [],
                    trades: trades || [],
                    notifications: notifications || [],
                    exportedAt: Date.now()
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                    type: 'application/json' 
                });
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Top-Margin -data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                showToast('Account data exported successfully', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Failed to export data', 'error');
            }
        }

        async function confirmLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await authManager.logout();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Failed to logout', 'error');
                }
            }
        }
        
        // Make functions available globally
        window.exportAccountData = exportAccountData;
        window.confirmLogout = confirmLogout;

        // Bottom Navigation Functionality
        function initializePageNavigation() {
          const navItems = document.querySelectorAll(".bottom-nav .nav-item");

          function showPage(pageName) {
            // Update active states
            navItems.forEach((btn) => btn.classList.remove("active"));
            const activeBtn = document.querySelector(
              `.bottom-nav .nav-item[data-page="${pageName}"]`
            );
            if (activeBtn) activeBtn.classList.add("active");

            // Navigate to the page
            switch(pageName) {
              case 'home':
                window.location.href = './dashboard.html';
                break;
              case 'trading':
                window.location.href = './trading.html';
                break;
              case 'transactions':
                window.location.href = './transfer.html';
                break;
              case 'notifications':
                window.location.href = './settings.html';
                break;
              case 'support':
                window.location.href = './customer-support.html';
                break;
            }
          }

          navItems.forEach((btn) => {
            btn.addEventListener("click", () => {
              const pageName = btn.getAttribute("data-page");
              showPage(pageName);
            });
          });
        }
    </script>
</body>
</html>
